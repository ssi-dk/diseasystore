---
title: "diseasystore: Google Health COVID-19 Open Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{diseasystore: Google Health COVID-19 Open Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(diseasystore)
```

```{r hidden_options, include = FALSE}
withr::local_options("tibble.print_min" = 5)
withr::local_options("diseasystore.verbose" = FALSE)
```

The Google COVID-19 data repository is a comprehensive open repository of COVID-19 data.

This vignette shows how to use (some of) this data through the `diseasystore` package.

First, it is a good idea to copy the relevant Google COVID-19 data files locally and store that location as an option for the package.
`DiseasystoreGoogleCovid19` uses only the age stratified metrics for COVID-19, so only a subset of the repository is needed to download.

```{r download_data, eval = FALSE}
# First we set the path we want to use as an option
options("diseasystore.DiseasystoreGoogleCovid19.source_conn" = file.path("local", "path"))

# Ensure folder exists
source_conn <- diseasyoption("source_conn", "DiseasystoreGoogleCovid19")
if (!dir.exists(source_conn)) {
  dir.create(source_conn, recursive = TRUE, showWarnings = FALSE)
}

# Define the Google files to download
google_files <- c("by-age.csv", "demographics.csv", "index.csv", "weather.csv")

# Download each file and compress them to reduce storage
purrr::walk(google_files, ~ {
  url <- paste0(diseasyoption("remote_conn", "DiseasystoreGoogleCovid19"), .)

  destfile <- file.path(
    diseasyoption("source_conn", "DiseasystoreGoogleCovid19"),
    .
  )

  if (!file.exists(paste0(destfile, ".gz"))) {
    download.file(url, destfile)
    R.utils::gzip(destfile)
  }
})
```

```{r download_data_hidden, include = FALSE}
# First we set the path we want to use as an option
source_conn <- "vignette_data"
withr::local_options("diseasystore.DiseasystoreGoogleCovid19.source_conn" = source_conn)
if (!dir.exists(source_conn)) dir.create(source_conn, recursive = TRUE, showWarnings = FALSE)
google_files <- c("by-age.csv", "demographics.csv", "index.csv", "weather.csv")
files_to_download <- purrr::discard(google_files, ~ file.exists(file.path(source_conn, paste0(., ".gz"))))

if (curl::has_internet()) {
  purrr::walk(files_to_download, ~ {
    url <- paste0(diseasyoption("remote_conn", "DiseasystoreGoogleCovid19"), .)

    destfile <-
      file.path(diseasyoption("source_conn", "DiseasystoreGoogleCovid19"), .)

    if (!file.exists(paste0(destfile, ".gz"))) {
      readr::read_csv(url, n_max = 1000, show_col_types = FALSE, progress = FALSE) |>
        readr::write_csv(destfile)
      R.utils::gzip(destfile)
    }
  })
} else {
  stop("Cannot download vignette files")
}
```


The `diseasystores` require a data base to store its features in.
These should be configured before use and can be stored in the packages options.
```{r configure_diseasystore}
# We will store the target_conn as a function that opens a DBIconnection to the DB
target_conn <- \() DBI::dbConnect(RSQLite::SQLite())
options("diseasystore.DiseasystoreGoogleCovid19.target_conn" = target_conn)
```


Once the files are downloaded and the target DB is configured, we can initialize the `diseasystore` that uses the Google COVID-19 data.
```{r initializing_diseasystore}
ds <- DiseasystoreGoogleCovid19$new()
```

Once configured such, we can also use the feature store directly to get data.
```{r using_diseasystore_example_1}
# We can see all the available features in the feature store
ds$available_features
```

```{r using_diseasystore_example_2}
# And then retrieve a feature from the feature store
ds$get_feature(feature = "n_hospital",
               start_date = as.Date("2020-01-01"),
               end_date = as.Date("2020-06-01"))
```
