<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Extending diseasystore - simulist example • diseasystore</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extending diseasystore - simulist example">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">diseasystore</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/diseasystore.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Package usage</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasystore-ecdc-respiratory-viruses.html">diseasystore: ECDC Respiratory Viruses Weekly</a></li>
    <li><a class="dropdown-item" href="../articles/diseasystore-google-covid-19.html">diseasystore: Google Health COVID-19 Open Data</a></li>
    <li><a class="dropdown-item" href="../articles/benchmarks.html">diseasystore: Benchmarks</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Developer guides</h6></li>
    <li><a class="dropdown-item" href="../articles/extending-diseasystore.html">Extending diseasystore</a></li>
    <li><a class="dropdown-item" href="../articles/extending-diseasystore-example.html">Extending diseasystore - simulist example</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ssi-dk/diseasystore/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Extending diseasystore - simulist example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ssi-dk/diseasystore/blob/v0.3.0/vignettes/extending-diseasystore-example.Rmd" class="external-link"><code>vignettes/extending-diseasystore-example.Rmd</code></a></small>
      <div class="d-none name"><code>extending-diseasystore-example.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ssi-dk/diseasystore" class="external-link">diseasystore</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>If you haven’t already, please consult the
<code><a href="../articles/extending-diseasystore.html">vignette("extending-diseasystore")</a></code> which explains the
concepts of the <code>diseasystore</code>s in detail.</p>
<p>In this example, we go through how to create a
<code>diseasystore</code> that implements individual level data. For
this purpose, we use a synthetic data set that we have generated using
the <a href="https://github.com/epiverse-trace/simulist" class="external-link">simulist</a> package. This data set is a synthetic line
list from a disease outbreak.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulist_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11,330 × 9</span></span></span>
<span><span class="co">#&gt;      id case_type sex   birth        age date_onset date_admission</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 confirmed m     1951-12-17    68 2019-12-01 2019-12-05    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 confirmed f     1962-12-15    57 2019-12-03 <span style="color: #BB0000;">NA</span>            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3 suspected m     1967-12-14    52 2019-12-04 2019-12-11    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4 suspected m     2005-12-10    14 2019-12-11 2019-12-15    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     6 probable  f     1929-12-28    90 2019-12-12 2019-12-17    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 11,325 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: date_discharge &lt;date&gt;, date_death &lt;date&gt;</span></span></span></code></pre></div>
<p>Given such a data set, the aim is to create a
<code>diseasystore</code> that can be used to retrieve features from
this data set.</p>
</div>
<div class="section level2">
<h2 id="feature-identification">Feature identification<a class="anchor" aria-label="anchor" href="#feature-identification"></a>
</h2>
<p>To do this, we need to identify the “features” that we want to store
in the <code>diseasystore</code>. In the data, there are some
demographic features such as “sex” and “age” and there are disease
specific features such as “date_onset”, “date_admission”, et cetera.</p>
<p>In this example we will implement the following features:</p>
<ul>
<li>Demographic features
<ul>
<li>
<code>birth</code> - The birth date of the individuals</li>
<li>
<code>age</code> - The (time-dependent) age of the individuals</li>
<li>
<code>sex</code> - The sex of the individuals</li>
</ul>
</li>
<li>Disease features
<ul>
<li>
<code>n_positive</code> - The positive tests performed on the
individuals</li>
<li>
<code>n_admission</code> - The time of admission among the
individuals</li>
<li>
<code>n_hospital</code> - The time of hospitalisation among the
individuals</li>
</ul>
</li>
</ul>
<p>Notice that the naming of the features differ by the prefix
<code>n_</code> versus no prefix. This dichotomy separates
“stratifications” from “observables”. Either is considered a “feature”
in the diseasystore, but the type of data (stratification
vs. observable) is used when we join the data in
<code><a href="../reference/DiseasystoreBase.html#method-DiseasystoreBase-key_join_features">$key_join_features()</a></code>. However, there are
no differences in the implementation of the features — only in the
naming.</p>
<p>This way of naming features follows the default convention of
<code>diseasystore</code>. However, we are free to overwrite with a
different naming convention if we want to. For example, say we also had
a feature the maximum and minimum temperature. we may want name the
features with the suffix <code>_temperature</code> instead (since we are
not dealing with the “number” of something). In that case, we would need
to update the <code>$.observables_regex</code> field to read<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;This is also the implementation in
&lt;code&gt;&lt;a href="../reference/DiseasystoreGoogleCovid19.html"&gt;?DiseasystoreGoogleCovid19&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;'><sup>1</sup></a>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">...</span></span>
<span>  <span class="va">private</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .observables_regex <span class="op">=</span> <span class="st">r"{^n_(?=\w)|_temperature$}"</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>With the features identified, we begin by assigning a
<code><a href="../reference/FeatureHandler.html">FeatureHandler</a></code> to each feature, and design the map between
the feature names and the responsible <code><a href="../reference/FeatureHandler.html">FeatureHandler</a></code>s:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>DiseasystoreSimulist <span class="ot">&lt;-</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="at">classname =</span> <span class="st">"DiseasystoreSimulist"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="at">inherit =</span> DiseasystoreBase,</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  ...</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    <span class="at">.ds_map =</span> <span class="fu">list</span>(</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>      <span class="st">"birth"</span>       <span class="ot">=</span> <span class="st">"simulist_birth"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>      <span class="st">"sex"</span>         <span class="ot">=</span> <span class="st">"simulist_sex"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>      <span class="st">"age"</span>         <span class="ot">=</span> <span class="st">"simulist_age"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>      <span class="st">"n_positive"</span>  <span class="ot">=</span> <span class="st">"simulist_positive"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>      <span class="st">"n_admission"</span> <span class="ot">=</span> <span class="st">"simulist_admission"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>      <span class="st">"n_hospital"</span>  <span class="ot">=</span> <span class="st">"simulist_hospital"</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    ),</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    <span class="at">.label =</span> <span class="st">"Simulist Synthetic Data"</span>,</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  ...</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>  )</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>)</span></code></pre></div>
<p>Notice that the names for the <code>?FeatureHandlers</code> have the
prefix “simulist_”. The features are stored in the data base using these
names, so we include the prefix to avoid any potential conflicts with
other features in the database. For example, the hospitalisation in
<code><a href="../reference/DiseasystoreGoogleCovid19.html">DiseasystoreGoogleCovid19</a></code> are stored in a table called
“google_covid_19_hospital”. Had both <code>diseasystores</code> omitted
the prefixes, they would both attempt to write to the same “hospital”
table in the database.</p>
</div>
<div class="section level2">
<h2 id="feature-implementation">Feature implementation<a class="anchor" aria-label="anchor" href="#feature-implementation"></a>
</h2>
<p>With the features identified, it is time to implement them in the
<code>diseasystore</code>.</p>
<p>That is, we need to construct the <code>?FeatureHandlers</code> for
each feature.</p>
<div class="section level3">
<h3 id="the-birth-featurehandler">The <code>birth</code> <code>FeatureHandler</code><a class="anchor" aria-label="anchor" href="#the-birth-featurehandler"></a>
</h3>
<p>We start by implementing the <code>birth</code> feature.</p>
<p>For this example, we will show first the code that implements the
<code><a href="../reference/FeatureHandler.html">FeatureHandler</a></code> and then describe the code in detail.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>private <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  ...</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="co"># The "birth" feature contains the birth dates of the individuals and is used later</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="co"># to compute the age of the individuals at any given time.</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="at">simulist_birth =</span> FeatureHandler<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    <span class="at">compute =</span> <span class="cf">function</span>(start_date, end_date, slice_ts, source_conn, ...) {</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>      out <span class="ot">&lt;-</span> simulist_data <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">transmute</span>(</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>          <span class="st">"key_pnr"</span> <span class="ot">=</span> .data<span class="sc">$</span>id,</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>          <span class="st">"birth"</span> <span class="ot">=</span> .data<span class="sc">$</span>birth,</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>          <span class="st">"valid_from"</span> <span class="ot">=</span> .data<span class="sc">$</span>birth,</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>          <span class="st">"valid_until"</span> <span class="ot">=</span> .data<span class="sc">$</span>date_death <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>          {{ start_date }} <span class="sc">&lt;</span> .data<span class="sc">$</span>valid_until,</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>          .data<span class="sc">$</span>valid_from <span class="sc">&lt;=</span> {{ end_date }}</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>        )</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>      <span class="fu">return</span>(out)</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>    },</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>    <span class="at">key_join =</span> key_join_count</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>  ),</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>  ...</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>)</span></code></pre></div>
<p>Notice that we create a new instance of <code><a href="../reference/FeatureHandler.html">FeatureHandler</a></code>
and assign it to the <code>simulist_birth</code> field in the private
list.</p>
<p>Lets focus on the <code><a href="../reference/FeatureHandler.html">FeatureHandler</a></code> we create: Here, we
need to define how the feature is computed (that is, we implement the
<code><a href="../reference/FeatureHandler.html#method-FeatureHandler-compute">$compute()</a></code> function).</p>
<p>The signature of this function is fixed, and must take the arguments
<code>start_date</code>, <code>end_date</code>, <code>slice_ts</code>,
<code>source_conn</code>, but can then take additional arguments in
<code>...</code>.</p>
<p>The <code>birth</code> feature is a simple feature that we can
extract directly from the underlying data set:
<code>simulist_data</code>.</p>
<p>In addition to the feature values themselves (the values stored in
the <code>birth</code> column) we need to include keying data that tells
<code>diseasystore</code> what other features this feature can be joined
to. Since we are working with individual level data, we can use a
personal identification number, “pnr”, as the key. The simulist data
already contains a unique ID for each individual, so we use this as the
personal identification number.</p>
<p>In addition, we need to specify the time period that the feature
covers. In this case, a birth date is assigned at birth, so we use this
as the <code>valid_from</code> date. For the expiration date of the
information, we could either use <code>NA</code>, since the birth date
is always valid, or we could use the date of death, if the individual
has died. In this implementation we use the latter, since this allows
for an easier implementation of the age of the individuals later on.</p>
<p>Notice that <code>valid_until</code> is set as the date after death.
The validity period of the features in <code>diseasystore</code> is the
interval
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtext mathvariant="normal">valid_from</mtext><mo>,</mo><mtext mathvariant="normal">valid_until</mtext><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">t \in \left[\textrm{valid_from}, \textrm{valid_until}\right)</annotation></semantics></math>.</p>
<p>After computing the feature, we filter to ensure that the data is
returned only for the requested time period.</p>
<p>Finally, we also specify how the feature can be summarised. That is,
we need to specify the type of <code>key_join</code> the feature should
use.</p>
<p>To illustrate how to determine the type of <code>key_join</code>, we
imagine that we want to determine the number of people who are born on
each date. Given our data set, we could perform the following operations
to summarize the data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulist_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">birth</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 91 × 2</span></span></span>
<span><span class="co">#&gt;   `lubridate::year(.data$birth)`     n</span></span>
<span><span class="co">#&gt;                            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                           <span style="text-decoration: underline;">1</span>929    96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                           <span style="text-decoration: underline;">1</span>930   131</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                           <span style="text-decoration: underline;">1</span>931   131</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                           <span style="text-decoration: underline;">1</span>932   119</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                           <span style="text-decoration: underline;">1</span>933   115</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 86 more rows</span></span></span></code></pre></div>
<p>That is, our feature has a record for each individual, and to
summarise the feature, we need to <code>count</code> the individuals
within each group. This is different from semi-aggregated data where we
would <code>sum</code> the values within each group (see
<code><a href="../reference/aggregators.html">aggregators</a></code> for available aggregators).</p>
</div>
<div class="section level3">
<h3 id="the-sex-featurehandler">The <code>sex</code> <code>FeatureHandler</code><a class="anchor" aria-label="anchor" href="#the-sex-featurehandler"></a>
</h3>
<p>We continue by implementing the <code>sex</code> feature.</p>
<p>Like the <code>birth</code> feature, this is a simple feature that we
can mostly extract directly from the data set:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>private <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  ...</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="co"># The "sex" feature simply stores the sex from the simulist data</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="at">simulist_sex =</span> FeatureHandler<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    <span class="at">compute =</span> <span class="cf">function</span>(start_date, end_date, slice_ts, source_conn, ds, ...) {</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>      out <span class="ot">&lt;-</span> simulist_data <span class="sc">|&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">right_join</span>( <span class="co"># Join with birth data to validity period</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>          ds<span class="sc">$</span><span class="fu">get_feature</span>(<span class="st">"birth"</span>, start_date, end_date, slice_ts),</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>          <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"key_pnr"</span>),</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>          <span class="at">copy =</span> <span class="cn">TRUE</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">transmute</span>(</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>          <span class="st">"key_pnr"</span> <span class="ot">=</span> .data<span class="sc">$</span>id,</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>          <span class="st">"sex"</span> <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(.data<span class="sc">$</span>sex <span class="sc">==</span> <span class="st">"m"</span>, <span class="st">"Male"</span>, <span class="st">"Female"</span>),</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>          .data<span class="sc">$</span>valid_from, .data<span class="sc">$</span>valid_until <span class="co"># Use values from birth feature</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>        )</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>      <span class="co"># No need to filter to ensure the data is only for the requested time period.</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>      <span class="co"># Since we right join with the birth feature, the validity period is already filtered.</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>      <span class="fu">return</span>(out)</span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>    },</span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>    <span class="at">key_join =</span> key_join_count</span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>  ),</span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>  ...</span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>)</span></code></pre></div>
<p>Notice that we again create a new instance of
<code><a href="../reference/FeatureHandler.html">FeatureHandler</a></code> and assign it to the
<code>simulist_sex</code> field in the private list.</p>
<p>The computation of the feature is mostly straightforward, but we
would like to use the validity period computed in the <code>birth</code>
feature (the same logic applies for the validity period of the “sex”
information as the “birth” information)</p>
<p>Therefore, we immediately see a difference in the function signature
of the <code><a href="../reference/FeatureHandler.html#method-FeatureHandler-compute">$compute()</a></code> function, where we include
the <code>ds</code> argument which, like the others, are passed to the
feature handler by <code>diseasystore</code> when we compute features.
This argument holds a reference to the <code>diseasystore</code> we are
building, so we can use it to retrieve other features (in this case, the
<code>birth</code> feature).</p>
<p>Once we have the <code>birth</code> feature, we combine it with the
<code>simulist_data</code> and extract a human-readable label for the
<code>sex</code>.</p>
</div>
<div class="section level3">
<h3 id="the-age-featurehandler">The <code>age</code> <code>FeatureHandler</code><a class="anchor" aria-label="anchor" href="#the-age-featurehandler"></a>
</h3>
<p>The <code>age</code> feature is a bit more complex than the previous
features, as it is a time-dependent feature.</p>
<p>Lets first look at the code:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>private <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  ...</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="co"># The "age" feature computes the age of the individuals throughout the study period</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="at">simulist_age =</span> FeatureHandler<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    <span class="at">compute =</span> <span class="cf">function</span>(start_date, end_date, slice_ts, source_conn, ds, ...) {</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>      <span class="co"># Using birth date, compute the age at the start of the study period</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>      age <span class="ot">&lt;-</span> ds<span class="sc">$</span><span class="fu">get_feature</span>(<span class="st">"birth"</span>, start_date, end_date, slice_ts) <span class="sc">|&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>          <span class="at">age_at_start =</span> <span class="fu">as.integer</span>(</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>            <span class="sc">!!</span><span class="fu">age_on_date</span>(<span class="st">"birth"</span>, start_date, <span class="at">conn =</span> ds <span class="sc">%.%</span> target_conn)</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>          )</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">compute</span>()</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>      <span class="co"># Now, compute the next birthdays of the individual</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>      <span class="co"># (as many as we need to cover the study period)</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>      <span class="co"># and compute the age of the individuals throughout the study period with their</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>      <span class="co"># birthdays denoting the starts and ends of the validity periods.</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>      out <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>        <span class="fu">seq.int</span>(</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>          <span class="at">from =</span> <span class="dv">0</span>,</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>          <span class="at">to =</span> <span class="fu">ceiling</span>(lubridate<span class="sc">::</span><span class="fu">interval</span>(start_date, end_date) <span class="sc">/</span> lubridate<span class="sc">::</span><span class="fu">years</span>(<span class="dv">1</span>))</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>        ),</span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>        <span class="sc">~</span> age <span class="sc">|&gt;</span></span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>            <span class="co"># The age for this iteration of the age computation loop</span></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>            <span class="st">"age"</span> <span class="ot">=</span> .data<span class="sc">$</span>age_at_start <span class="sc">+</span> .x</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>( <span class="co"># Split to make the "age" column available for the next mutate</span></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>            <span class="co"># Compute the birthday for the age</span></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a>            <span class="st">"birthday"</span> <span class="ot">=</span> <span class="sc">!!</span><span class="fu">add_years</span>(<span class="st">"birth"</span>, <span class="st">"age"</span>, <span class="at">conn =</span> ds <span class="sc">%.%</span> target_conn)</span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>( <span class="co"># Again, split to make "birthday" available for the next mutate</span></span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a>            <span class="co"># And when that age is not valid</span></span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>            <span class="st">"next_birthday"</span> <span class="ot">=</span> <span class="sc">!!</span><span class="fu">add_years</span>(<span class="st">"birthday"</span>, <span class="dv">1</span>, <span class="at">conn =</span> ds <span class="sc">%.%</span> target_conn)</span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>( <span class="co"># Remove the birthdays that fall outside of the study period</span></span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a>            .data<span class="sc">$</span>birthday <span class="sc">&lt;=</span> {{ end_date }},</span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a>            .data<span class="sc">$</span>birthday <span class="sc">&lt;</span> .data<span class="sc">$</span>valid_until <span class="sc">|</span> <span class="fu">is.na</span>(.data<span class="sc">$</span>valid_until)</span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">transmute</span>( <span class="co"># We assign the birth dates as the validity periods</span></span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a>            <span class="st">"key_pnr"</span> <span class="ot">=</span> .data<span class="sc">$</span>key_pnr,</span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>            <span class="st">"age"</span> <span class="ot">=</span> .data<span class="sc">$</span>age,</span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a>            <span class="st">"valid_from"</span> <span class="ot">=</span> .data<span class="sc">$</span>birthday,</span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a>            <span class="st">"valid_until"</span> <span class="ot">=</span> <span class="fu">pmin</span>(</span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a>              .data<span class="sc">$</span>valid_until,</span>
<span id="cb8-49"><a href="#cb8-49" tabindex="-1"></a>              .data<span class="sc">$</span>next_birthday,</span>
<span id="cb8-50"><a href="#cb8-50" tabindex="-1"></a>              <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb8-51"><a href="#cb8-51" tabindex="-1"></a>            )</span>
<span id="cb8-52"><a href="#cb8-52" tabindex="-1"></a>          )</span>
<span id="cb8-53"><a href="#cb8-53" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb8-54"><a href="#cb8-54" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">reduce</span>(dplyr<span class="sc">::</span>union_all) <span class="co"># Collapse to a single dataset</span></span>
<span id="cb8-55"><a href="#cb8-55" tabindex="-1"></a></span>
<span id="cb8-56"><a href="#cb8-56" tabindex="-1"></a>      <span class="fu">return</span>(out)</span>
<span id="cb8-57"><a href="#cb8-57" tabindex="-1"></a>    },</span>
<span id="cb8-58"><a href="#cb8-58" tabindex="-1"></a>    <span class="at">key_join =</span> key_join_count</span>
<span id="cb8-59"><a href="#cb8-59" tabindex="-1"></a>  ),</span>
<span id="cb8-60"><a href="#cb8-60" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" tabindex="-1"></a>  ...</span>
<span id="cb8-62"><a href="#cb8-62" tabindex="-1"></a>)</span></code></pre></div>
<p>As with the <code>sex</code> feature, this feature also depends on
the <code>birth</code> feature, so we include the <code>ds</code>
argument in the function signature of
<code><a href="../reference/FeatureHandler.html#method-FeatureHandler-compute">$compute()</a></code>.</p>
<p>Since the age is time-dependent, we need to compute the age of the
individuals at the start of the study period (i.e. the period requested
by the user), and compute their age throughout the study period.</p>
<p>The age at the start of the study period is computed directly by from
the birth date of the individuals using the age helper function
<code><a href="../reference/age_on_date.html">age_on_date()</a></code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Notice that we don’t use &lt;a href="https://lubridate.tidyverse.org" class="external-link"&gt;lubridate&lt;/a&gt; or
syntax such as &lt;code&gt;birth_date + 365&lt;/code&gt;. As you may recall from the
primer &lt;code&gt;&lt;a href="../articles/extending-diseasystore.html"&gt;vignette("extending-diseasystore")&lt;/a&gt;&lt;/code&gt;, features are
stored in data bases, not as R objects. Therefore, the operations we
perform must be translatable to SQL via &lt;a href="https://dbplyr.tidyverse.org/" class="external-link"&gt;dbplyr&lt;/a&gt; and date
arithmetic are not currently translatable consistently.
&lt;code&gt;diseasystore&lt;/code&gt; therefore provides some helper functions for
the type of date-related arithmetic that is common in feature
computation. These are available for the data base back ends supported
by &lt;code&gt;diseasystore&lt;/code&gt;.&lt;/p&gt;'><sup>2</sup></a>.</p>
<p>Once the age at start is known, we determine the length of the study
period (in years) and compute the birthdays of the individuals
throughout the period<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Notice that we split the &lt;code&gt;&lt;a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link"&gt;dplyr::mutate()&lt;/a&gt;&lt;/code&gt;
calls into several calls since SQL translation works differently from
“normal” &lt;a href="https://dplyr.tidyverse.org" class="external-link"&gt;dplyr&lt;/a&gt; behaviour. Normally in
&lt;a href="https://dplyr.tidyverse.org" class="external-link"&gt;dplyr&lt;/a&gt;, the variable created earlier in one
&lt;code&gt;&lt;a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link"&gt;dplyr::mutate()&lt;/a&gt;&lt;/code&gt; call is available immediately after, but
this is not the case in SQL syntax. Therefore, we split the
&lt;code&gt;&lt;a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link"&gt;dplyr::mutate()&lt;/a&gt;&lt;/code&gt; calls which generates nested sub-queries
which makes the variables available in subsequent calls.&lt;/p&gt;'><sup>3</sup></a>. Each birthday has an associated age and a
validity period which runs from the birthday to the next birthday.
Notice that we sometimes compute birthdays that fall outside of the
study period, which we filter out before combining to a single data set
with <code><a href="https://dplyr.tidyverse.org/reference/setops.html" class="external-link">dplyr::union_all()</a></code>.</p>
<p>In all, we end with a data set containing the time-dependent age of
the individuals throughout the study period.</p>
</div>
<div class="section level3">
<h3 id="the-n_positive-featurehandler">The <code>n_positive</code> <code>FeatureHandler</code><a class="anchor" aria-label="anchor" href="#the-n_positive-featurehandler"></a>
</h3>
<p>The <code>n_positive</code> feature is a simple feature that we can
extract directly from the data set with a little filtering:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>private <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  ...</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="co"># The "n_positive" feature contains the positive tests taken by the individuals</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="at">simulist_positive =</span> FeatureHandler<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>    <span class="at">compute =</span> <span class="cf">function</span>(start_date, end_date, slice_ts, source_conn, ...) {</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>      out <span class="ot">&lt;-</span> simulist_data <span class="sc">|&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(.data<span class="sc">$</span>case_type <span class="sc">==</span> <span class="st">"confirmed"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">transmute</span>(</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>          <span class="st">"key_pnr"</span> <span class="ot">=</span> .data<span class="sc">$</span>id,</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>          <span class="st">"valid_from"</span> <span class="ot">=</span> .data<span class="sc">$</span>date_onset,</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>          <span class="st">"valid_until"</span> <span class="ot">=</span> .data<span class="sc">$</span>valid_from <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>          {{ start_date }} <span class="sc">&lt;</span> .data<span class="sc">$</span>valid_until,</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>          .data<span class="sc">$</span>valid_from <span class="sc">&lt;=</span> {{ end_date }}</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>        )</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>      <span class="fu">return</span>(out)</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    },</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>    <span class="at">key_join =</span> key_join_count</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>  ),</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>  ...</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-n_hospital-featurehandler">The <code>n_hospital</code> <code>FeatureHandler</code><a class="anchor" aria-label="anchor" href="#the-n_hospital-featurehandler"></a>
</h3>
<p>Like the <code>n_positive</code> feature, the <code>n_hospital</code>
is straightforward to implement:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>private <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  ...</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="co"># The "n_hospital" feature contains the hospitalizations of the individuals</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="at">simulist_hospital =</span> FeatureHandler<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    <span class="at">compute =</span> <span class="cf">function</span>(start_date, end_date, slice_ts, source_conn, ds, ...) {</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>      out <span class="ot">&lt;-</span> simulist_data <span class="sc">|&gt;</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>          .data<span class="sc">$</span>case_type <span class="sc">==</span> <span class="st">"confirmed"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(.data<span class="sc">$</span>date_admission)</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">transmute</span>(</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>          <span class="st">"key_pnr"</span> <span class="ot">=</span> .data<span class="sc">$</span>id,</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>          <span class="st">"valid_from"</span> <span class="ot">=</span> .data<span class="sc">$</span>date_admission,</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>          <span class="st">"valid_until"</span> <span class="ot">=</span> .data<span class="sc">$</span>date_discharge <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>          {{ start_date }} <span class="sc">&lt;</span> .data<span class="sc">$</span>valid_until,</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>          .data<span class="sc">$</span>valid_from <span class="sc">&lt;=</span> {{ end_date }}</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>        )</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>      <span class="fu">return</span>(out)</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>    },</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>    <span class="at">key_join =</span> key_join_count</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>  ),</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>  ...</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-n_admission-featurehandler">The <code>n_admission</code> <code>FeatureHandler</code><a class="anchor" aria-label="anchor" href="#the-n_admission-featurehandler"></a>
</h3>
<p>For the <code>n_admission</code> feature, we use the already computed
<code>n_hospital</code> feature to compute the admissions. We could have
computed directly from the simulist data, but since this features is
really just a transformation of the <code>n_hospital</code> feature, we
use the <code>n_hospital</code> feature to compute the admissions.</p>
<p>Since we modify the <code>valid_until</code> field, we need to filter
again to ensure that the data is only for the requested time period.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>private <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  ...</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="co"># The "n_admission" feature contains the admissions of the individuals</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="co"># We here use the "n_hospital" feature to compute the admissions since the admission</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="co"># is an entry for the first date of hospitalisation</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="at">simulist_admission =</span> FeatureHandler<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    <span class="at">compute =</span> <span class="cf">function</span>(start_date, end_date, slice_ts, source_conn, ds, ...) {</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>      out <span class="ot">&lt;-</span> ds<span class="sc">$</span><span class="fu">get_feature</span>(<span class="st">"n_hospital"</span>, start_date, end_date, slice_ts) <span class="sc">|&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">"valid_until"</span> <span class="ot">=</span> .data<span class="sc">$</span>valid_from <span class="sc">+</span> <span class="dv">1</span><span class="dt">L</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>({{ start_date }} <span class="sc">&lt;</span> .data<span class="sc">$</span>valid_until) <span class="co"># valid_from filtered in n_hospital</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>      <span class="fu">return</span>(out)</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>    },</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>    <span class="at">key_join =</span> key_join_count</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  )</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>  ...</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="the-final-product">The final product<a class="anchor" aria-label="anchor" href="#the-final-product"></a>
</h2>
<p>We are finally ready to see the <code>diseasystore</code> in
action.</p>
<div class="section level3">
<h3 id="configuring-the-diseasystore">Configuring the <code>diseasystore</code><a class="anchor" aria-label="anchor" href="#configuring-the-diseasystore"></a>
</h3>
<p>All <code>diseasystores</code> require a database to store its
features in. For convenience, we here set the <code>target_conn</code>
option<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The &lt;code&gt;&lt;a href="../articles/diseasystore.html"&gt;vignette("diseasystore")&lt;/a&gt;&lt;/code&gt; explains the
options system in more detail.&lt;/p&gt;'><sup>4</sup></a>
for all <code>diseasystores</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We define target_conn as a function that opens a DBIconnection to the DB</span></span>
<span><span class="va">target_conn</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="op">)</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span></span>
<span>  <span class="st">"diseasystore.target_conn"</span> <span class="op">=</span> <span class="va">target_conn</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>With the <code>target_conn</code> option set, we can easily create a
new instance of the <code>diseasystore</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">diseasystore</span><span class="fu">::</span><span class="va"><a href="../reference/DiseasystoreSimulist.html">DiseasystoreSimulist</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="retrieving-features">Retrieving features<a class="anchor" aria-label="anchor" href="#retrieving-features"></a>
</h3>
<p>We can see that the features we implemented are available:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span><span class="op">$</span><span class="va">available_features</span></span>
<span><span class="co">#&gt; [1] "birth"       "age"         "sex"         "n_positive"  "n_admission"</span></span>
<span><span class="co">#&gt; [6] "n_hospital"</span></span></code></pre></div>
<p>And we can retrieve the individual features</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span><span class="op">$</span><span class="fu">get_feature</span><span class="op">(</span></span>
<span>  feature <span class="op">=</span> <span class="st">"sex"</span>,</span>
<span>  start_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">min_start_date</span>,</span>
<span>  end_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">max_end_date</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: method with signature 'DBIConnection#Id' chosen for function 'dbExistsTable',</span></span>
<span><span class="co">#&gt;  target signature 'duckdb_connection#Id'.</span></span>
<span><span class="co">#&gt;  "duckdb_connection#ANY" would also be valid</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;dbplyr_fYWxNDvhnc&gt; [?? x 4]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB v1.1.3 [unknown@Linux 6.5.0-1025-azure:R 4.4.2/:memory:]</span></span></span>
<span><span class="co">#&gt;   key_pnr sex    valid_from valid_until</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       1 Male   1951-12-17 2019-12-09 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      40 Female 1931-12-11 2020-01-12 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>      69 Male   1945-11-21 2020-01-18 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>      82 Female 2001-10-19 2020-01-24 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>      99 Male   1948-10-21 2020-01-30 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span><span class="op">$</span><span class="fu">get_feature</span><span class="op">(</span></span>
<span>  feature <span class="op">=</span> <span class="st">"n_positive"</span>,</span>
<span>  start_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">min_start_date</span>,</span>
<span>  end_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">max_end_date</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;dbplyr_biPlfS5HbO&gt; [?? x 3]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB v1.1.3 [unknown@Linux 6.5.0-1025-azure:R 4.4.2/:memory:]</span></span></span>
<span><span class="co">#&gt;   key_pnr valid_from valid_until</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      46 2020-01-10 2020-01-11 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      47 2020-01-03 2020-01-04 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>      57 2020-01-02 2020-01-03 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>      59 2019-12-29 2019-12-30 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>      64 2020-01-03 2020-01-04 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combining-features">Combining features<a class="anchor" aria-label="anchor" href="#combining-features"></a>
</h3>
<p>Since we have individual level data, we can combine the features
arbitrarily using any stratification that we want. This stratification
can by any expression using the features in the
<code>diseasystore</code>. Since we are working expressions, we need to
pass the expressions as “quosures” using <code><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">rlang::quos()</a></code>.</p>
<p>These expressions have very few limits. As long as they are
translatable by <a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a> to SQL, they can be used.</p>
<p>Lets look at some examples:</p>
<div class="section level4">
<h4 id="no-stratification">No stratification<a class="anchor" aria-label="anchor" href="#no-stratification"></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the number of positive tests by age group and sex</span></span>
<span><span class="va">data1</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">$</span><span class="fu">key_join_features</span><span class="op">(</span></span>
<span>  observable <span class="op">=</span> <span class="st">"n_positive"</span>,</span>
<span>  stratification <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  start_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">min_start_date</span>,</span>
<span>  end_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">max_end_date</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">data1</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 152 × 2</span></span></span>
<span><span class="co">#&gt;   date       n_positive</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2019-12-01          1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2019-12-02          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2019-12-03          1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2019-12-04          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2019-12-05          0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 147 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data1</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">n_positive</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="extending-diseasystore-example_files/figure-html/no_stratifications_plot-1.png" alt="The number of positive tests over time in the example data." width="700"></p>
</div>
<div class="section level4">
<h4 id="stratifying-by-a-custom-age-group">Stratifying by a custom age group<a class="anchor" aria-label="anchor" href="#stratifying-by-a-custom-age-group"></a>
</h4>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the number of positive tests by age group and sex</span></span>
<span><span class="va">data2</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">$</span><span class="fu">key_join_features</span><span class="op">(</span></span>
<span>  observable <span class="op">=</span> <span class="st">"n_positive"</span>,</span>
<span>  stratification <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quos</a></span><span class="op">(</span></span>
<span>    age_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span></span>
<span>      <span class="va">age</span>,</span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span>, <span class="fl">30</span>, <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>      labels <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/age_labels.html">age_labels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      right <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="va">sex</span></span>
<span>  <span class="op">)</span>,</span>
<span>  start_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">min_start_date</span>,</span>
<span>  end_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">max_end_date</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 912 × 4</span></span></span>
<span><span class="co">#&gt;   date       age_group sex    n_positive</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2019-12-01 30+       Female          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2019-12-02 30+       Female          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2019-12-03 30+       Female          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2019-12-04 30+       Female          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2019-12-05 30+       Female          0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 907 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data2</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">n_positive</span>, color <span class="op">=</span> <span class="va">age_group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span><span class="op">)</span></span></code></pre></div>
<p><img src="extending-diseasystore-example_files/figure-html/stratifications_positive_sex_age_plot-1.png" alt="The number of positive tests over time per age group and sex in the example data." width="700"></p>
</div>
<div class="section level4">
<h4 id="stratifying-by-generation">Stratifying by generation<a class="anchor" aria-label="anchor" href="#stratifying-by-generation"></a>
</h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the number of admissions by generation</span></span>
<span><span class="va">data3</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">$</span><span class="fu">key_join_features</span><span class="op">(</span></span>
<span>  observable <span class="op">=</span> <span class="st">"n_admission"</span>,</span>
<span>  stratification <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quos</a></span><span class="op">(</span></span>
<span>    generation <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">birth</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1946</span> <span class="op">~</span> <span class="st">"Silent or older"</span>,</span>
<span>      <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">birth</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1965</span> <span class="op">~</span> <span class="st">"Boomer"</span>,</span>
<span>      <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">birth</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1981</span> <span class="op">~</span> <span class="st">"GenX"</span>,</span>
<span>      <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">birth</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1997</span> <span class="op">~</span> <span class="st">"Millenial"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"GenZ"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  start_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">min_start_date</span>,</span>
<span>  end_date <span class="op">=</span> <span class="va">ds</span><span class="op">$</span><span class="va">max_end_date</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">data3</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 760 × 3</span></span></span>
<span><span class="co">#&gt;   date       generation n_admission</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2019-12-01 Millenial            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2019-12-02 Millenial            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2019-12-03 Millenial            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2019-12-04 Millenial            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2019-12-05 Millenial            0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 755 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data3</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">n_admission</span>, color <span class="op">=</span> <span class="va">generation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="extending-diseasystore-example_files/figure-html/stratifications_admission_generation_plot-1.png" alt="The number of positive tests over time per age group in the example data." width="700"></p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rasmus Skytte Randløv, <a href="https://www.ssi.dk/" class="external-link"><img src="https://www.ssi.dk/assets/images/ssi-logo-optimeret.svg" alt="SSI" height="64" style="margin-bottom: 0.5em; margin-top: 1.5em;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
